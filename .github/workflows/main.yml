name: workflow

on:
  push:
    branches:
      - main
      - master
    paths-ignore:
      - 'README.md'
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  integration:
    name: Continuous Integration
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Lint code
        run: echo "Linting repository"

      - name: Run unit tests
        run: echo "Running unit tests"

  build-and-push-ecr-image:
    name: Continuous Delivery
    needs: integration
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Install Utilities
        run: |
          sudo apt-get update
          sudo apt-get install -y jq unzip
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1

      - name: Build, tag, and push image to Amazon ECR
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY_NAME }}
          IMAGE_TAG: latest
        run: |
          # Build a docker container and
          # push it to ECR so that it can
          # be deployed to ECS.
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT
          
          
  Continuous-Deployment:
    needs: build-and-push-ecr-image
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Clean up disk space before deployment
        run: |
          echo "=== Disk usage before cleanup ==="
          df -h
          echo "=== Docker disk usage ==="
          docker system df
          echo "=== Cleaning Docker resources ==="
          # Stop and remove existing container if running
          docker ps -q --filter "name=grid-demo" | xargs -r docker stop
          docker ps -aq --filter "name=grid-demo" | xargs -r docker rm -f
          # Aggressive cleanup of Docker resources
          docker system prune -af --volumes
          docker image prune -af
          # Remove all unused images, not just dangling ones
          docker images -q | xargs -r docker rmi -f 2>/dev/null || true
          # Clean containerd cache if it exists
          sudo rm -rf /var/lib/containerd/io.containerd.content.v1.content/ingest/* 2>/dev/null || true
          # Clean up any temporary files
          sudo rm -rf /tmp/* 2>/dev/null || true
          # Clean apt cache
          sudo apt-get clean 2>/dev/null || true
          echo "=== Disk usage after cleanup ==="
          df -h
          echo "=== Docker disk usage after cleanup ==="
          docker system df

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1
      
      - name: Pull latest images with retry and cleanup
        run: |
          IMAGE_URI="${{secrets.AWS_ECR_LOGIN_URI}}/${{ secrets.ECR_REPOSITORY_NAME }}:latest"
          echo "=== Pulling image: $IMAGE_URI ==="
          
          # Check available disk space
          AVAILABLE_SPACE=$(df / | tail -1 | awk '{print $4}')
          AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
          echo "=== Available disk space: ${AVAILABLE_GB}GB ==="
          
          if [ $AVAILABLE_GB -lt 2 ]; then
            echo "WARNING: Less than 2GB available, performing additional cleanup..."
            # Emergency cleanup
            docker container prune -f
            docker volume prune -f
            docker network prune -f
            sudo rm -rf /var/log/*.log 2>/dev/null || true
            sudo rm -rf /home/ubuntu/.cache/* 2>/dev/null || true
            sudo journalctl --vacuum-time=1d 2>/dev/null || true
            
            AVAILABLE_SPACE=$(df / | tail -1 | awk '{print $4}')
            AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
            echo "=== Available disk space after emergency cleanup: ${AVAILABLE_GB}GB ==="
          fi
          
          # Try to pull the image with retry logic
          for i in {1..3}; do
            echo "Attempt $i to pull image..."
            if docker pull "$IMAGE_URI"; then
              echo "Image pulled successfully on attempt $i"
              break
            else
              echo "Pull failed on attempt $i"
              if [ $i -eq 3 ]; then
                echo "All pull attempts failed"
                exit 1
              fi
              
              # Clean up more aggressively before retry
              echo "Cleaning up before retry..."
              docker system prune -af --volumes
              docker images -q | head -5 | xargs -r docker rmi -f 2>/dev/null || true
              sudo rm -rf /var/lib/containerd/io.containerd.content.v1.content/ingest/* 2>/dev/null || true
              sudo rm -rf /tmp/docker-* 2>/dev/null || true
              
              echo "=== Disk space after cleanup ==="
              df -h
              sleep 10
            fi
          done
       
      - name: Run Docker Image to serve users
        run: |
         docker run -d -p 8000:8000 --ipc="host" --name=grid-demo -e 'AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}' -e 'AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}' -e 'AWS_REGION=${{ secrets.AWS_REGION }}'  ${{secrets.AWS_ECR_LOGIN_URI}}/${{ secrets.ECR_REPOSITORY_NAME }}:latest
      
      - name: Verify deployment
        run: |
          echo "=== Container status ==="
          docker ps --filter "name=grid-demo"
          echo "=== Final disk usage ==="
          df -h